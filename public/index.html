<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CRUD Pacientes</title>
    <style>
        body{font-family:Arial;margin:40px}
        input{margin:5px;padding:5px}
        button{padding:6px}
        table{border-collapse:collapse;margin-top:20px}
        td,th{border:1px solid #ccc;padding:8px}
        #app{display:none}
        #msg{margin:10px 0;color:green}
        #err{margin:10px 0;color:red}
    </style>
</head>

<body>

<h2>Login</h2>
<div id="login">
    <input id="user" placeholder="Usuario">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">Entrar</button>
</div>

<div id="app">

<h2>Crear Paciente</h2>
<div id="msg"></div>
<div id="err"></div>

<input id="nombre1" placeholder="Nombre">
<input id="apellido1" placeholder="Apellido">
<input id="correo" placeholder="Correo">
<button onclick="crear()">Guardar</button>

<h2>Pacientes</h2>

<table id="tabla">
<thead>
<tr>
<th>ID</th>
<th>Nombre</th>
<th>Correo</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="logout()">Cerrar sesión</button>

</div>

<script>

const BASE = "http://localhost:8000";

/* LOGIN */

async function login(){
    let res = await fetch(BASE+'/login',{
        method:'POST',
        credentials:'include',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            username:document.getElementById('user').value,
            password:document.getElementById('pass').value
        })
    });

    let data = await res.json();

    if(data.mensaje){
        document.getElementById('login').style.display='none';
        document.getElementById('app').style.display='block';
        cargar();
    }else{
        alert(data.error || "Error login");
    }
}

/* LOGOUT */

async function logout(){
    await fetch(BASE+'/logout',{credentials:'include'});
    location.reload();
}

/* LISTAR */

async function cargar(){
    let res = await fetch(BASE+'/pacientes',{credentials:'include'});
    let data = await res.json();

    if(data.error){
        alert("Sesión expirada");
        location.reload();
        return;
    }

    let tbody=document.querySelector('#tabla tbody');
    tbody.innerHTML='';

    data.forEach(p=>{
        tbody.innerHTML+=`
        <tr>
            <td>${p.id}</td>
            <td>${p.nombre1} ${p.apellido1}</td>
            <td>${p.correo}</td>
            <td><button onclick="eliminar(${p.id})">Eliminar</button></td>
        </tr>`;
    });
}

/* CREAR */

async function crear(){

    let paciente={
        tipo_documento_id:1,
        numero_documento:Date.now().toString(),
        nombre1:document.getElementById('nombre1').value,
        nombre2:'',
        apellido1:document.getElementById('apellido1').value,
        apellido2:'',
        genero_id:1,
        departamento_id:1,
        municipio_id:1,
        correo:document.getElementById('correo').value
    };

    let res = await fetch(BASE+'/pacientes',{
        method:'POST',
        credentials:'include',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(paciente)
    });

    let data = await res.json();

    if(data.mensaje){
        document.getElementById('msg').innerText=data.mensaje;
        cargar();
    }else{
        document.getElementById('err').innerText=data.error || "Error";
    }
}

/* ELIMINAR */

async function eliminar(id){
    await fetch(BASE+'/pacientes/'+id,{
        method:'DELETE',
        credentials:'include'
    });
    cargar();
}

</script>

</body>
</html>